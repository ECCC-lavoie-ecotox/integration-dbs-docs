---
title: "Injections des données"
author: "Steve Vissault"
date: "2024-04-29"
execute: 
  eval: false
---

## Création de la base de données
 

```{R}
con <- DBI::dbConnect(RSQLite::SQLite(), "Z:/07-Données BD/Database/contaminants-rlavoie-eccc.sqlite")
db_ddl_sql <- strsplit(paste(readLines("sql/db_create_ddl.sql"), collapse = "\n"), ";\n")[[1]]
purrr::walk(db_ddl_sql, \(x) DBI::dbExecute(con, x))
```

## Étape d'injections des données

Afin de respecter l'intégrité référentielle des données, l'injection des données doit se faire dans un certain ordre. Il faut par exemple renseigner en premier l'ensemble des sites avant de pouvoir déclarer les échantillons associés. 

Voici l'ordre d'injection attendu au regard de la structure de la base de données.

1. Sites
2. Species 
3. Projects
4. Field samples
5. Lab samples 
6. Analyte
7. Lab measurement

L'ensemble des données destinés à populer les tables a été consolider lors des étapes précédentes. Nous allons maintenant procéder à leur importation dans la base de données.

## Importation des données

###  Table `sites`

```{R}
sites <- readRDS("data/tbl_sites.rds")
```

On tranforme les intitulées de colonnes du data.frame pour qu'ils correspondent à ceux de la table de données SQL.

```{R}
data_sites <- sites |>
    dplyr::select(
        id_site = final_id,
        province, 
        lat,
        lon,
        srid
    )

DBI::dbWriteTable(con, "sites", data_sites, append = TRUE)
```

###  Table `species`

```{R}
data_species <- readRDS("data/tbl_species.rds")
DBI::dbWriteTable(con, "species", data_species, append = TRUE)
```

###  Table `field_sample`

```{R}
map_sites <- readRDS("data/tbl_sites.rds") |>
    tidyr::separate_rows(original_ids, sep = ";") |>
    dplyr::select(original_ids, final_id)

options(dplyr.summarise.inform = FALSE)

samples <- itgr_samples_info() |>
  dplyr::select(-received_date, -id_project, -id_source_report, -source) |>
  dplyr::mutate(collection_date = as.character(collection_date)) |>
  # Ajout des identifiants de site consolidé
  dplyr::left_join(map_sites, by = c("id_site" = "original_ids")) |>
  dplyr::select(-id_site) |>
  dplyr::rename(id_site = final_id) |>
  dplyr::mutate_if(is.character, stringr::str_trim) |>
  dplyr::mutate_if(is.character, ~ifelse(.x == "N/A", NA, .x)) |>
  dplyr::mutate_if(is.character, ~ifelse(.x == "NA", NA, .x)) |>
  dplyr::distinct() |>
  # Nettoyage des duplicates pour la combinaison id_field_sample, id_lab_sample
  dplyr::group_by(
    dplyr::across(c(-age, -tissue, -collection_date))
  ) |> dplyr::summarise(
    age = paste0(na.omit(age), collapse = ";"),
    tissue = paste0(na.omit(tissue), collapse = ";"),
    collection_date = max(collection_date)
  ) |> dplyr::ungroup()

# Nettoyage
# Appliquer un str_trim sur toute les colonnes de texte
# Replace NA, N/A par NA
# Si age pas NA, prendre le pas NA
# If date more precise than 1977-01-01, prendre la date plus précise
# Remove last letter in id_lab_sample

# Join
DBI::dbWriteTable(con, "field_sample", samples, append = TRUE)
```

### Table `project`

```{R}

contaminants <- toxbox::itgr_measurements() |>
  dplyr::select(
    id_site = Location
  )
```
